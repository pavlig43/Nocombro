#!/bin/bash

set -e

echo "Running pre-commit hooks..."

# Get list of staged Kotlin/Gradle files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|kts|gradle)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "No Kotlin/Gradle files staged. Skipping checks."
    exit 0
fi

echo "Staged files:"
echo "$STAGED_FILES"
echo ""

# Run Detekt (autoCorrect is enabled in config)
echo "Running Detekt (formatting + check)..."
./gradlew detektAll --continue

# Check if any files were modified by detekt
MODIFIED_FILES=$(git diff --name-only || true)

if [ -n "$MODIFIED_FILES" ]; then
    echo ""
    echo "Detekt made changes to your code!"
    echo "Modified files:"
    echo "$MODIFIED_FILES"
    echo ""
    echo "Please review the changes and stage them again:"
    echo "  git add $MODIFIED_FILES"
    echo ""
    echo "Then run git commit again."
    exit 1
fi

echo ""
echo "Pre-commit checks passed!"
exit 0
