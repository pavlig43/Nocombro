# Бизнес-логика Nocombro

## 1. Контрагенты (Vendor)

**Сущность:** `Vendor`

**Назначение:** Контрагент — может быть поставщиком ИЛИ клиентом (одна сущность).

**Связи:**
- Как **поставщик** → `Declaration` (декларации качества)
- Как **клиент** → `SaleBDIn` (продажи)

---

## 2. Декларация качества (Declaration)

**Сущность:** `Declaration`

**Назначение:** Документ качества от производителя.

**Правила:**
- Без декларации **продукт не может существовать**
- Создаётся поставщиком и загружается на официальный сайт
- Действует ограниченное время (например, 3 года)
- В системе хранятся и просроченные (для истории)

**Связи:**
- Принадлежит `Vendor` (поставщику)
- Связь с `Product` — M:N (через `ProductDeclarationIn`)
  - Один продукт может иметь **несколько** деклараций (актуальная + просроченные)
  - Одна декларация может покрывать **несколько** продуктов

---

## 3. Продукт (Product)

**Сущность:** `Product`

**Типы:**
- `FOOD_BASE` — Пищевой базовый (сырьё: мука, сахар, соль)
- `FOOD_PF` — Пищевой полуфабрикат (тесто, фарш)
- `PACK` — Упаковка

**Поля:**
- `priceForSale` — справочная цена продажи (копейки)

**Правила:**
- **НЕ может существовать без Declaration** (обязательная связь)
- Может иметь состав (`CompositionIn`) — для полуфабрикатов

**Связи:**
- M:N с `Declaration` (обязательно минимум одна)
- 1:N с `Batch` (партии)
- M:N с `Product` (состав) — через `CompositionIn`

---

## 4. Состав продукта (CompositionIn)

**Сущность:** `CompositionIn`

**Назначение:** Рецептура — из чего состоит продукт.

**Пример:** "Тесто" = Мука 500г + Яйца 2шт + Вода 200мл

**Использование:**
1. Для **справки** — посмотреть состав продукта
2. Как **шаблон** при заполнении формы ОПЗС (подставляет ингредиенты)

**Важно:** Реальный расход фиксируется через `BatchMovement`, не через `CompositionIn`.

---

## 5. Партия (Batch)

**Сущность:** `Batch`

**Назначение:** Физическая партия товара на складе.

**Поля:**
- `dateBorn` — дата производства **с упаковки** (не дата поступления!)

**Правила создания:**

| Способ | Когда создаётся | Declaration |
|--------|-----------------|-------------|
| **Покупка (BUY)** | При покупке товара | Выбирается из списка |
| **Производство (OPZS)** | При производстве полуфабриката | Выбирается вручную |

> **Важно:** Партия НЕ может быть создана отдельно от транзакции.

**Остаток партии:**
```
Остаток = SUM(INCOMING.count) - SUM(OUTGOING.count)
```

---

## 6. Движение партии (BatchMovement)

**Сущность:** `BatchMovement`

**Типы движения:**
- `INCOMING` — Приход
- `OUTGOING` — Расход

**Создание OUTGOING движений:**

| Операция | Выбор партии | Статус |
|----------|--------------|--------|
| **Продажа (SALE)** | Пользователь выбирает вручную | ✅ Реализовано |
| **Производство (OPZS)** | Пользователь выбирает компоненты вручную | ✅ Реализовано |
| **Списание (WRITE_OFF)** | Пользователь выбирает вручную | ⏳ Не реализовано |
| **Инвентаризация (INVENTORY)** | Автоматически по всем партиям | ✅ Реализовано |

> **Важно:** Система НЕ подбирает партии автоматически (нет FIFO).

---

## 7. Транзакции (Transaction)

**Сущность:** `Transact`

**Типы:**

| Тип | Описание | Что создаётся |
|-----|----------|---------------|
| **BUY** | Покупка | `Batch` + `BatchMovement(INCOMING)` + `BuyBDIn` |
| **SALE** | Продажа | `BatchMovement(OUTGOING)` + `SaleBDIn` |
| **OPZS** | Отчёт производства за смену | `BatchMovement` для компонентов (OUTGOING) + полуфабриката (INCOMING) |
| **WRITE_OFF** | Списание | `BatchMovement(OUTGOING)` |
| **INVENTORY** | Инвентаризация | `BatchMovement` для каждой партии (корректировка остатков) |

---

## 8. Покупка (BUY)

**Сущность:** `BuyBDIn`

**Логика:**
```
BUY → BuyBDIn (с ценой) → Batch (партия) → BatchMovement(INCOMING)
```

**Поля:**
- `price` — цена закупки в копейках (хранится исторически)

**Для UI:** `BuyBDOut` собирается через @Relation.

---

## 9. Продажа (SALE)

**Сущность:** `SaleBDIn`

**Логика:**
```
SALE → SaleBDIn (с ценой) → BatchMovement(OUTGOING)
```

**Цена:**
- **Продажи:** вводится вручную, берётся из `Product.priceForSale` как дефолт (можно отредактировать)
- **Себестоимость:** берётся из `BuyBDIn.price` (цена закупки партии)
- **Маржа = Цена продажи − Себестоимость**

**Клиент:** `client_id` → `Vendor` (контрагент)

---

## 10. Производство (OPZS)

**DTO:** `PfBD` (полуфабрикат), `IngredientBD` (ингредиент)

**Логика:**
1. `CompositionIn` заполняет форму (шаблон рецептуры)
2. Для каждого компонента → `BatchMovement(OUTGOING)`
3. Для готового полуфабриката → создаётся **новая Batch** + `BatchMovement(INCOMING)`
4. Declaration выбирается вручную

---

## 11. Инвентаризация (INVENTORY)

**Логика:**
1. Пользователь вводит фактическое количество по каждой партии
2. Если факт > остаток → `BatchMovement(INCOMING)` — доначисление
3. Если факт < остаток → `BatchMovement(OUTGOING)` — списание

---

## 12. Файлы (FileBD)

**Сущность:** `FileBD`

**Назначение:** Универсальная система прикрепления файлов.

**OwnerType:**
- `DECLARATION` — скан сертификата
- `PRODUCT` — фото товара
- `VENDOR` — документы поставщика
- `DOCUMENT` — техническая документация
- `TRANSACTION` — документы по транзакции

---

## 13. Напоминания (ReminderBD)

**Сущность:** `ReminderBD`

**Назначение:** Напоминания о любых событиях.

**Связи:** Привязаны к `Transaction`.

**Примеры:** напомнить об оплате, поставке, чём угодно (свободный текст).

---

## 14. Расходы (ExpenseBD)

**Сущность:** `ExpenseBD`

**Типы:**
- `TRANSPORT_GASOLINE` — Бензин
- `TRANSPORT_DELIVERY` — Доставка
- `TRANSPORT_DEPRECIATION` — Амортизация авто
- `STATIONERY` — Канцелярия
- `COMMISSION` — Комиссионные

**Связи:** Опционально к `Transaction`.

---

## Диаграмма зависимостей

```
Vendor (Контрагент)
  ├── (как поставщик) → Declaration
  │     └── (M:N) ←→ Product [ОБЯЗАТЕЛЬНО]
  │           ├── priceForSale
  │           ├── (M:N) ←→ Product (состав) [CompositionIn]
  │           └── (1:N) → Batch
  │                 ├── dateBorn (дата производства)
  │                 ├── (1:N) → BatchMovement
  │                 │     ├── movementType (INCOMING/OUTGOING)
  │                 │     └── (N:1) → Transaction
  │                 │
  │           Transaction
  │                 ├── type: BUY/SALE/OPZS/WRITE_OFF/INVENTORY
  │                 ├── (1:N) → BuyBDIn (цена закупки)
  │                 ├── (1:N) → SaleBDIn (цена продажи + клиент)
  │                 ├── (1:N) → ReminderBD
  │                 └── (1:N?) → ExpenseBD
  │
  └── (как клиент) ← SaleBDIn.client_id

FileBD → OwnerId, OwnerType (DECLARATION/PRODUCT/VENDOR/DOCUMENT/TRANSACTION)
Document (техническая документация: GOST, SPECIFICATION)
```

---

## Правила дизайна

### 1. @Relation вместо raw SQL JOINs
Используй `@Relation` аннотацию в Room Database вместо написания JOIN запросов.

### 2. Храни десятичные числа как Int
- **Деньги** — в копейках (×100)
- **Вес** — в граммах (×1000)

### 3. Без дублирования данных
Если данные есть в родительской сущности — не дублируй в дочерней.
